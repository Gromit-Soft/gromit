defaultTasks 'jar'

apply plugin: 'checkstyle'
apply plugin: 'java'
apply plugin: 'application'
apply plugin: 'maven'

group = 'org.gromitsoft'
version = '0.1-SNAPSHOT'


repositories {
    mavenCentral()
    maven {
        url 'http://oss.sonatype.org/content/groups/public'
    }
}

dependencies {
    compile 'org.apache.tomcat:tomcat-servlet-api:7.0.37'
    compile 'org.json:json:20141113'   
}

/*
 * This section deals with processing and combining JavaScript files.  Our JavaScript files have some specific
 * dependencies where we must load some files ahead of others.  This section specifies the file tree in a specific
 * order so our JavaScript dependencies are loaded properly in the index.html file.
 */
FileCollection jsFiles = files('src/main/js/gromit.js', 'src/main/js/rest.js', 'src/main/js/util.js', 'src/main/js/oauth.js')
    
jsFiles = jsFiles + fileTree(
    dir: 'src/main/js', 
    includes: ['*.js'],
    excludes: ['iac.js', 'rest.js', 'util.js', 'oauth.js', 'main.js'])
    
jsFiles = jsFiles + fileTree(
    dir: 'src/main/js', 
    includes: ['directives/**', 'services/**'], 
    excludes: ['**/services/i18n/*'])
    
buildscript {
  repositories {
    mavenCentral()
    maven {
        url 'http://oss.sonatype.org/content/groups/public'
    }
  }
  dependencies {
    classpath 'com.eriwen:gradle-js-plugin:1.12.0'
    classpath 'com.eriwen:gradle-css-plugin:1.11.1'
  }
}

apply plugin: "com.eriwen.gradle.js"
apply plugin: 'css'

minifyJs {
    source = jsFiles
    dest = file("${buildDir}/js/gromit-min.js")
    closure {
        warningLevel = 'DEFAULT'
        compilationLevel = 'WHITESPACE_ONLY'
    }
}

gzipJs {
	doFirst() {
	    println ':gzipJs'
	}
    source = file("${buildDir}/js/gromit-all-min.js")
    dest = file("${buildDir}/js/gromit-all-min.js.gz")
}

/*
 * This is a little class and task that can concatenate files.  We use it to bundle all 
 * of our JavaScript libraries into a single file.  Ideally we should be GZIPing the bundle
 * as well, but I haven't had time for that part yet.
 */
class ConcatFiles extends DefaultTask {
    @InputFiles
    FileCollection files
    @OutputFile
    File target
    @TaskAction
    void concat() {
        target.withWriter { writer ->
            files.each { file ->
                file.withReader { reader ->
                    writer << reader << '\n'
                }
            }
        }
    }
}

task concatLibFiles(type: ConcatFiles) {
    files = files(
        'src/main/js/lib/Markdown.Converter.js',
        'src/main/js/lib/Markdown.Sanitizer.js',
        'src/main/js/lib/Markdown.Editor.js',
        'build/js/gromit-min.js')
    target = file('build/js/gromit-all-min.js')
}

/*
 * This section minimizes and combines our CSS files
 */
FileCollection cssSourceFiles = files('src/main/css/reset.css', 'src/main/css/coreui.css', 'src/main/css/client.css')

FileTree cssSourceFilesTree = fileTree(dir: 'src/main/css')
cssSourceFilesTree.include '*.css'
cssSourceFilesTree.exclude 'coreui.css, reset.css, client.css'
cssSourceFiles = cssSourceFiles + cssSourceFilesTree

combineCss {
    source = cssSourceFiles
    dest = "${buildDir}/css/gromit-all.css"
}

minifyCss {
    source = "${buildDir}/css/gromit-all.css"
    dest = "${buildDir}/css/gromit-all-min.css"
    yuicompressor { // Optional
        lineBreakPos = -1
    }
}

gzipCss {
	doFirst() {
	    println ':gzipCss'
	}
    source = "${buildDir}/css/gromit-all-min.css"
    dest = "${buildDir}/css/gromit-all-min.css.gz"
}

checkstyle {
    configFile new File(rootDir, 'build/config/checkstyle_checks.xml')
}

/*
 * We want to call JSHint on the command line so we can use the NodeJS version
 * of it.
 */
task jsHint(type:Exec) {
	doFirst() {
	    println ':jsHint'
	}
    description = 'This task handles calling JSHint for the JavaScript files in the project.'
    ignoreExitValue = true
    
	
	if (org.apache.tools.ant.taskdefs.condition.Os.isFamily(org.apache.tools.ant.taskdefs.condition.Os.FAMILY_WINDOWS)) {
		commandLine 'cmd', '/c', 'jshint'
	} else {
		workingDir '.'
		executable 'jshint'
	}
    args jsFiles
	
	logger.info('jsHint commandLine: ' + commandLine)
    doLast {
        if (execResult.exitValue != 0) {
            throw new GradleScriptException("There were JSHint errors.  Look above and fix the issues.", null);
        }
    }
}

clean {
    FileTree l10nFiles = fileTree(dir: 'src/main/js/services/i18n/')
    l10nFiles.include '*.js'
    delete l10nFiles
    
    l10nFiles.include '*.xlf'
    delete l10nFiles
}

compileJava.doFirst {
    tasks.checkstyleMain.execute()
}

jar.doFirst {
    tasks.jsHint.execute()
    tasks.minifyJs.execute()
    tasks.concatLibFiles.execute()
    tasks.gzipJs.execute()
    
    tasks.combineCss.execute()
    tasks.minifyCss.execute()
    tasks.gzipCss.execute()
}

